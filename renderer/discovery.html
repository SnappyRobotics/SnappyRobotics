<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Discovery Wizard</title>
	</head>

	<link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Roboto:400,500,700,400italic'>
	<link rel="stylesheet" type="text/css" href="../bower_components/angular-material/angular-material.css">
	<style media="screen">
		.hidden {
			position: absolute;
			z-index: -999999;
		}
	</style>
	<script type="text/javascript" src="../bower_components/angular/angular.js"></script>
	<script type="text/javascript" src="../bower_components/angular-aria/angular-aria.js"></script>
	<script type="text/javascript" src="../bower_components/angular-animate/angular-animate.js"></script>
	<script type="text/javascript" src="../bower_components/angular-material/angular-material.js"></script>
	<script type="text/javascript" src="../bower_components/angular-route/angular-route.js"></script>

	<body ng-app="app">
		<ng-view>
		</ng-view>
		<script type="text/javascript">
			angular
				.module('app', ['ngMaterial', 'ngAnimate', 'ngRoute'])
				.config(['$mdThemingProvider', '$routeProvider', '$locationProvider', function($mdThemingProvider, $routeProvider, $locationProvider) {
					$mdThemingProvider
						.theme('docs-dark', 'default')
						.primaryPalette('yellow')
						.dark()
						.foregroundPalette['3'] = 'yellow'

					$routeProvider
						.when('/', {
							templateUrl: "templates/discoveryController.html",
							controller: 'discoveryController'
						})
						.when('/connecting', {
							templateUrl: "templates/connectingController.html",
							controller: 'connectingController'
						})
						.when('/login', {
							templateUrl: "templates/loginController.html",
							controller: 'loginController'
						})

					// .otherwise({
					// 	templateUrl: "templates/loginController.html",
					// 	controller: 'loginController',
					// })
				}])
				.controller('discoveryController', ['$scope', function($scope) {
					debug("discoveryController started");

					$scope.start_core = function() {
						window.device = '127.0.0.1'
						setTimeout(function() {
							ipc.send('discovery:start_core');
						}, 100);
						window.location.href = '#!/login'
					}

					$scope.connect = function(ip) {
						window.device = ip
						setTimeout(function() {
							ipc.send('discovery:connect_core', ip);
						}, 100);
						window.location.href = '#!/login'
					}

					$scope.start_scanning = function() {
						ipc.send('discovery:start_scanning');
						$scope.status = "searching..";
						$scope.scanning = true;
						$scope.devices = [];
					}

					ipc.on("discovery:devices", function(em, devices) {
						debug("Got :" + devices);

						$scope.$apply(function() {
							$scope.devices = devices;
						})
					})
					ipc.on("discovery:searching", function(em, ip) {
						debug("Searching for :" + ip);

						$scope.$apply(function() {
							$scope.searching = ip;
						})
					})
					ipc.on("discovery:scan_done", function(em, devices) {
						var isArr = Object.prototype.toString.call(devices) == '[object Array]';
						if (isArr) {
							$scope.$apply(function() {
								$scope.status = "Scan complete";
								$scope.scanning = false;
								if (typeof devices === 'string' || devices instanceof String) {
									$scope.devices = devices.split(',')
								} else {
									$scope.devices = devices;
								}
							})
						} else {
							$scope.$apply(function() {
								$scope.status = "Scan complete";
								$scope.devices = []
							});
						}
					})

					$scope.start_scanning()
				}])
				.controller('connectingController', ['$scope', function($scope) {
					debug("connectingController started");

					$scope.cancelLoading = function() {
						ipc.send('discovery:cancel_loading_core');
					}

					ipc.on("discovery:cancel_start_core", function(em, devices) {
						window.location.href = '#!/'
					})
				}])
				.controller('loginController', ['$scope', function($scope) {
					debug("loginController started");
					$scope.device = window.device
				}])
		</script>
	</body>

</html>
